<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Shift & Overtime Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light gray background */
        }
        /* Custom calendar styling */
        .calendar-day {
            min-height: 100px;
            cursor: pointer;
            transition: all 0.2s;
            @apply border border-gray-200 p-2 rounded-lg relative text-sm;
        }
        .calendar-day:hover:not(.day-disabled) {
            @apply shadow-md scale-[1.01] bg-gray-50;
        }
        .day-disabled {
            background-color: #e2e8f0;
            color: #94a3b0;
        }

        /* --- COLOR-CODING BASED ON SHIFT TYPE AND MODIFICATION --- */
        
        /* Standard Weekday (Mon-Fri) */
        .shift-standard-default { background-color: #d1fae5; } /* Light Green (Green 100) */
        .shift-standard-modified { background-color: #6ee7b7; } /* Darker Green (Green 300) */
        
        /* Standard Weekend (Sat/Sun) */
        .shift-weekend-default { background-color: #ffe4c4; } /* Light Orange (Orange 100) */
        .shift-weekend-modified { background-color: #fdba74; } /* Darker Orange (Orange 300) */
        
        /* General Overtime (Non-BH) */
        .shift-overtime-default { background-color: #fbcfe8; } /* Light Pink (Pink 100) */
        .shift-overtime-modified { background-color: #f472b6; } /* Darker Pink (Pink 400) */
        
        /* Bank Holiday Overtime */
        .shift-bh-ot-default { background-color: #f3e8ff; } /* Light Purple (Purple 100) */
        .shift-bh-ot-modified { background-color: #c084fc; } /* Darker Purple (Purple 400) */
        
        /* Bank Holiday (Standard Hours) */
        .shift-bank-holiday { background-color: #e2e8f0; } /* Light Grey (Gray 200) */
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="mb-2">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Personal Shift Tracker</h1>
        </header>
		
		<div class="flex items-center justify-between text-xs text-indigo-700 mt-1 mb-4">
            <p class="font-medium">Version: <span class="font-normal">timesheetGASv18_42a_test</span></p>
            <p id="device-info"></p> 
        </div>
		
        <div id="displayed-profile-section" class="bg-indigo-50 p-4 rounded-xl shadow-inner mb-4 flex justify-between items-center hidden">
            <div class="text-indigo-900 space-y-1">
                <p class="text-sm font-medium">Name: <span id="display-userName" class="font-bold"></span></p>
                <p class="text-sm font-medium">Payroll No: <span id="display-payrollNumber" class="font-bold"></span></p>
                <p class="text-sm font-medium">Email: <span id="display-userEmail" class="font-bold"></span></p>
                <p class="text-sm font-medium">Contracted Hours: <span id="display-contractedHours" class="font-bold"></span></p>
            </div>
            <button onclick="editProfile()" class="text-indigo-600 hover:text-indigo-800 text-sm font-semibold py-1 px-3 rounded-lg bg-white/50 hover:bg-white transition">
                Change
            </button>
        </div>

        <div id="profile-input-section" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Details (Saved Locally)</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="userName" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="userName" placeholder="Your Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label for="payrollNumber" class="block text-sm font-medium text-gray-700">Payroll Number</label>
                    <input type="text" id="payrollNumber" placeholder="Your Payroll No." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label for="userEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="userEmail" placeholder="username@email.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label for="contractedHoursSelect" class="block text-sm font-medium text-gray-700">Contracted Hours (Per Week)</label>
                    <select id="contractedHoursSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" onchange="checkCustomContractedHours()">
                        <option value="37.5">37.5 Hours (Default)</option>
                        <option value="25">25.0 Hours</option>
                        <option value="12.5">12.5 Hours</option>
                        <option value="custom">Custom Hours</option>
                    </select>
                </div>
                <div id="customHoursInputContainer" class="hidden">
                    <label for="customContractedHours" class="block text-sm font-medium text-gray-700">Custom Hours</label>
                    <input type="number" step="0.5" id="customContractedHours" placeholder="e.g. 30" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div class="flex items-end md:col-span-1">
                    <button onclick="saveProfile()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                        Save Profile
                    </button>
                </div>
            </div>
        </div>

<div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <button onclick="changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-100 transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12 15.75 4.5" /></svg></button>
                <h2 id="current-month-year" class="text-3xl font-bold text-gray-900"></h2>
                <button onclick="changeMonth(1)" class="p-2 rounded-full hover:bg-gray-100 transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5 15.75 12 8.25 19.5" /></svg></button>
            </div>
            
            <div class="grid grid-cols-7 gap-1 text-center font-medium text-gray-600 mb-2">
                <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
            </div>

            <div id="calendar-grid" class="grid grid-cols-7 gap-1">
            </div>
            
            <!-- Standard Action Buttons (Left and Right) -->
            <div class="mt-6 flex justify-between items-center pt-4 border-t border-gray-200">
                <button onclick="clearAllShifts()" class="
                    bg-red-600 hover:bg-red-700 text-white font-bold 
                    py-2 px-4 rounded-lg shadow-lg transition duration-150 ease-in-out">
                    <span>Clear <span id="clear-month-text">Current Month's</span> Shifts</span>
                </button>
                
                <button id="report-button" onclick="generateReport()" class="
                    bg-purple-600 hover:bg-purple-700 text-white font-bold 
                    py-2 px-4 rounded-lg shadow-lg hover:bg-purple-700 transition duration-150 ease-in-out">
                    <span id="report-button-text">Generate Monthly Report</span>
                </button>
            </div>

            <!-- Factory Reset Section (Centered Below) -->
            <div class="mt-6 flex justify-center items-center pt-4 border-t border-gray-100 pb-2">
                <button onclick="hardReset()" class="
                    bg-red-800 hover:bg-red-900 text-white font-bold 
                    py-2 px-4 rounded-lg shadow-lg transition duration-150 ease-in-out">
                    <span>âš  Factory Reset (Delete All Data)</span>
                </button>
            </div>
        </div>
        <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl text-center">
                <p id="message-text" class="text-lg font-medium text-gray-700">Loading...</p>
                <button onclick="hideMessageBox()" class="mt-4 bg-indigo-500 text-white py-2 px-4 rounded-lg hidden" id="message-close-btn">Close</button>
            </div>
        </div>
    </div>


    <div id="shift-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center hidden z-40 p-4">
        <div class="bg-white w-full max-w-lg max-h-[90vh] rounded-xl shadow-2xl p-6 transform transition-all duration-300 overflow-y-auto">
            <h3 class="text-2xl font-bold text-gray-800 mb-2" id="modal-date-display">Shift Details for [Date]</h3>
            <p class="text-sm text-gray-500 mb-6">Standard Shift: 07:20 - 20:30 (12.5 hours total, 40 min breaks)</p>
            <form id="shift-form">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Shift Type</label>
                    <div class="mt-1 space-y-2">
                        <label class="inline-flex items-center mr-4">
                            <input type="radio" name="shiftType" value="Standard" class="form-radio text-indigo-600 h-4 w-4" checked onchange="calculateEnhancements()">
                            <span class="ml-2 text-gray-700">Standard (Weekday/Weekend)</span>
                        </label>
                        <label class="inline-flex items-center mr-4">
                            <input type="radio" name="shiftType" value="Overtime" class="form-radio text-red-600 h-4 w-4" onchange="calculateEnhancements()">
                            <span class="ml-2 text-gray-700">Overtime (Non-BH)</span>
                        </label>
                        <hr class="my-1 border-gray-100">
                        <label class="inline-flex items-center mr-4">
                            <input type="radio" name="shiftType" value="Bank Holiday" class="form-radio text-blue-600 h-4 w-4" onchange="calculateEnhancements()">
                            <span class="ml-2 text-gray-700">Bank Holiday (Standard Hours)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="shiftType" value="Bank Holiday Overtime" class="form-radio text-purple-600 h-4 w-4" onchange="calculateEnhancements()">
                            <span class="ml-2 text-gray-700">Bank Holiday Overtime</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="startTime" class="block text-sm font-medium text-gray-700">Start Time (HH:MM)</label>
                        <input type="time" id="startTime" value="07:20" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" onchange="calculateEnhancements()">
                    </div>

                    <div class="mb-4">
                        <label for="finishTime" class="block text-sm font-medium text-gray-700">Finish Time (HH:MM)</label>
                        <input type="time" id="finishTime" value="20:30" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" onchange="calculateEnhancements()">
                    </div>
                </div>

                <div id="breaks-section" class="mb-6 border p-4 rounded-lg bg-gray-50">
                    <p class="text-sm font-semibold text-gray-700 mb-2">Breaks (20 min each)</p>
                    <p class="text-xs text-gray-500 mb-2">Adjustable if shift starts after 13:00 or finishes before 18:00.</p>
                    <label for="breaksCount" class="block text-sm font-medium text-gray-700">Number of Unpaid 20 min Breaks</label>
                    <select id="breaksCount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" onchange="calculateEnhancements()">
                        <option value="2">2 (40 minutes total - Default)</option>
                        <option value="1">1 (20 minutes total)</option>
                        <option value="0">0 (0 minutes total)</option>
                    </select>
                </div>

                <div id="deviation-selectors" class="mb-6 space-y-3 p-4 border rounded-lg bg-yellow-50/70">
                    <p class="font-bold text-lg mb-2 text-yellow-800">Time Deviation Management</p>
                </div>
                
                <!-- NEW: Notes Section -->
                <div class="mb-4">
                    <label for="shiftNotes" class="block text-sm font-medium text-gray-700">Shift Notes</label>
                    <textarea id="shiftNotes" rows="2" placeholder="Reason for OT, ward worked, etc." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                </div>

                <div class="mb-6 p-4 border rounded-lg bg-indigo-50">
                    <p class="font-bold text-lg mb-2 text-indigo-700">Calculated Shift Summary</p>
                    <div id="enhancement-display" class="space-y-1 text-sm text-indigo-800">
                        </div>
                </div>

                <div class="flex justify-between items-center pt-4 border-t">
                    <div class="flex space-x-2">
                        <button type="button" onclick="closeShiftModal()" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                        <button type="button" onclick="deleteShift()" id="delete-shift-btn" class="py-2 px-4 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition hidden">Delete Shift</button>
                    </div>
                    <button type="submit" class="py-2 px-6 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition">Save Shift</button>
                </div>
            </form>
        </div>
    </div>
    

<div id="report-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center hidden z-40 p-4">
    <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-xl shadow-2xl p-6 transform transition-all duration-300 overflow-y-auto">
        <h3 class="text-2xl font-bold text-gray-800 mb-2" id="report-title">Monthly Shift Report</h3>
        <p class="text-sm text-gray-500 mb-6" id="report-period"></p>

<div class="p-4 border-t border-gray-200 mt-6 flex justify-between items-center">
    
        
   
        <!-- NEW SEND BUTTON -->
        <button onclick="prepareAndShowSendDialog()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded transition shadow-md flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
            </svg>
            Send Shift Data
        </button>
        <!-- EXISTING PRINT BUTTON -->
        <button onclick="showPrintInstructions()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-3 rounded transition shadow-md">
            Print Report (PDF)
        </button>


 <div class="flex space-x-3">
        <button onclick="closeReportModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1.5 px-3 rounded transition">
            Close
        </button>


    </div>
</div>
		
        <div id="report-content" class="space-y-4">
            <div class="bg-gray-100 p-4 rounded-lg">
                <p class="font-semibold text-lg mb-2">Summary Totals (Hours)</p>
                <table class="min-w-full divide-y divide-gray-200">
                    <tbody id="report-table-body" class="divide-y divide-gray-200 text-gray-700">
                        </tbody>
                </table>
            </div>
            
            <div class="mt-8 pt-4 border-t border-gray-200">
                <p class="font-semibold text-lg mb-4 text-gray-800">Detailed Shift Log</p>
                <div id="detailed-shift-list" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>
</div>
	
<div id="instruction-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 transform transition-all duration-300">
        <h3 class="text-2xl font-bold text-gray-800 mb-4" id="instruction-modal-title">Print Instructions</h3>
        
        <div id="instruction-content" class="text-gray-700 space-y-4 mb-6">
            </div>

        <div class="flex justify-end space-x-3 pt-4 border-t">
            <button onclick="document.getElementById('instruction-modal').classList.add('hidden')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition">
                Cancel
            </button>
            <button onclick="handlePrintButtonClick()" id="modal-print-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition shadow-md">
                Print
            </button>
        </div>
    </div>
</div>

<!-- NEW SEND DATA MODAL -->
<div id="send-data-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white w-full max-w-4xl max-h-[90vh] rounded-xl shadow-2xl p-6 flex flex-col">
        <h3 class="text-2xl font-bold text-gray-800 mb-2">Data to send to sth.mritimesheets:</h3>

        <!-- Preview Table -->
        <div class="overflow-auto flex-grow border border-gray-200 rounded-lg mb-4 bg-gray-50 p-2">
            <table class="min-w-full text-xs text-left text-gray-600">
                <thead class="bg-gray-200 font-bold text-gray-800">
                    <tr>
                        <th class="p-2">Date</th>
                        <th class="p-2">Type</th>
                        <th class="p-2">Start-End</th>
                        <th class="p-2">UH (Sat/Sun/Nt/BH)</th>
                        <th class="p-2">Extra Hrs</th>
                        <th class="p-2">OT (M-F/Sat/Sun/BH)</th>
                        <th class="p-2">TOIL (Acc/Used)</th>
                        <th class="p-2">AL Used</th>
                        <th class="p-2">Notes</th>
                    </tr>
                </thead>
                <tbody id="send-data-preview-body" class="divide-y divide-gray-200">
                    <!-- Rows generated by JS -->
                </tbody>
            </table>
        </div>

        <!-- Webhook URL Display (Read-Only) -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Google Apps Script Web App URL</label>
            <p id="xyz" class="mt-1 text-xs text-gray-400 font-mono break-all bg-gray-50 p-2 rounded border border-gray-200">
				https://script.google.com/macros/s/AKfycbwxIuNelcJs2xSBInoLeV2BhVMPBlhpi958SvDY1NiPfiLXz1EgVNvLrcv4jgbfcFmx/exec
            </p>
        </div>

        <!-- Actions -->
        <div class="flex justify-end space-x-3 pt-4 border-t">
            <button onclick="document.getElementById('send-data-modal').classList.add('hidden')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition">
                Cancel
            </button>
            <button onclick="sendDataToGoogle()" id="btn-send-gas" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition shadow-md">
                Send Now
            </button>
        </div>
    </div>
</div>

<script>
        // --- GLOBAL STATE ---
        let currentYear, currentMonth;
        let userProfile = { name: '', payrollNumber: '', userEmail: '', contractedHours: 37.5 };
        let userShifts = {}; // Key: "YYYY-MM-DD", Value: { shiftData }
        let selectedDate = null;
        let currentReportData = { totals: {}, shiftsInMonth: [], monthName: '' }; // Cache for print function

        // Standard shift times
        const DEFAULT_START_TIME_MINUTES = timeToMinutes('07:20');
        const DEFAULT_END_TIME_MINUTES = timeToMinutes('20:30');
        const NIGHT_DUTY_START_MINUTES = timeToMinutes('20:00');
        const NIGHT_DUTY_END_MINUTES = timeToMinutes('20:30');

        // --- LOCAL STORAGE KEY CONSTANTS ---
        const PROFILE_KEY = 'userProfile';
        const SHIFTS_KEY = 'userShifts';

		// Detect if the user is on an Apple device
		const isAppleDevice = /Macintosh|Mac OS|iPhone|iPad|iPod/.test(navigator.userAgent);

		// This will store the active print scale factor
		let PRINT_SCALE_FACTOR;
			const APPLE_SCALE = 0.73;
			const DEFAULT_SCALE = 1.0;

        // --- UTILITY FUNCTIONS ---
window.hardReset = function() {
    if (confirm("WARNING: This will delete ALL shift history and your profile details from this device.\n\nThis action cannot be undone.\n\nAre you sure?")) {
        // Remove specific keys
        localStorage.removeItem('userShifts');
        localStorage.removeItem('userProfile');
        localStorage.removeItem('printScaleFactor');
        
        // Or use localStorage.clear() to wipe everything for this domain
        
        alert("All data deleted. The page will now reload.");
        location.reload();
    }
}


function detectDeviceAndBrowser() {
    const userAgent = navigator.userAgent;
    let device = 'Unknown Device';
    let browser = 'Unknown Browser';

    if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
        device = 'iOS (iPhone/iPad)';
    } else if (/Android/.test(userAgent)) {
        device = 'Android Mobile';
    } else if (/Macintosh|Mac OS X/.test(userAgent)) {
        device = 'Mac/OSX PC';
    } else if (/Windows/.test(userAgent)) {
        device = 'Windows PC';
    } else if (/Linux/.test(userAgent)) {
        device = 'Linux PC';
    } else if (/CrOS/.test(userAgent)) {
        device = 'ChromeOS';
    }

    if (userAgent.indexOf("Edg") !== -1) {
        browser = "Microsoft Edge";
    } else if (userAgent.indexOf("Chrome") !== -1 && userAgent.indexOf("Edg") === -1) {
        browser = "Google Chrome";
    } else if (userAgent.indexOf("Safari") !== -1) {
        browser = "Safari";
    } else if (userAgent.indexOf("Firefox") !== -1) {
        browser = "Mozilla Firefox";
    } else if (userAgent.indexOf("Trident") !== -1 || userAgent.indexOf("MSIE") !== -1) {
        browser = "Internet Explorer";
    }

    return `System: ${device}, Browser: ${browser}`;
}

function classifyDeviceForInstructions() {
    const userAgent = navigator.userAgent;
    const isWindows = /Windows/i.test(userAgent);
    const isAndroid = /Android/i.test(userAgent);
    const isMacOriOS = /Macintosh|Mac OS X|iPhone|iPad|iPod/i.test(userAgent);

    if (isMacOriOS) {
        return 'Apple'; 
    } else if (isAndroid) {
        return 'Android';
    } else if (isWindows) {
        return 'WindowsPC';
    } else {
        return 'OtherPC'; 
    }
}
		
        // Helper: Convert "HH:MM" string to minutes from midnight
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return (hours * 60) + minutes;
        }

        // Helper: Convert minutes to decimal hours (two decimal places)
        function minutesToDecimalHours(minutes) {
            return (minutes / 60);
        }
        
        // Helper: Format hours for display
function formatHours(minutes) {
    if (!Number.isFinite(minutes)) {
        return '0.00';
    }
    return minutesToDecimalHours(minutes).toFixed(2);
}
        
        // Helper: Format hours for the print form (blank if zero)
        function formatHoursForPrint(minutes) {
            return minutes > 0.01 ? minutesToDecimalHours(minutes).toFixed(2) : '';
        }

        function showMessageBox(title, message, closable = false) {
            const box = document.getElementById('message-box');
            document.getElementById('message-text').innerHTML = `<strong>${title}:</strong> ${message}`;
            const closeBtn = document.getElementById('message-close-btn');
            if (closable) {
                closeBtn.classList.remove('hidden');
                closeBtn.onclick = hideMessageBox;
            } else {
                closeBtn.classList.add('hidden');
            }
            box.classList.remove('hidden');
        }

        function hideMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
        }
        
        // --- NEW HELPERS FOR WEEKLY HOURS ---
        
        function getMonday(dateStr) {
            const d = new Date(dateStr);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
            const monday = new Date(d.setDate(diff));
            return monday.toISOString().split('T')[0];
        }

        // function getWeeklyPaidMinutes
	function getWeeklyPaidMinutes(targetDateStr) {
            const targetDate = new Date(targetDateStr);
            const mondayStr = getMonday(targetDateStr);
            const mondayDate = new Date(mondayStr);
            const nextMondayDate = new Date(mondayDate);
            nextMondayDate.setDate(mondayDate.getDate() + 7);

            let totalMinutes = 0;

            Object.keys(userShifts).forEach(dateKey => {
                // Skip the specific date we are currently editing
                if (dateKey === targetDateStr) return;

                const shiftDate = new Date(dateKey);
                // Check if this shift falls within the target week
                if (shiftDate >= mondayDate && shiftDate < nextMondayDate) {
                    const shift = userShifts[dateKey];
                    
                    // FIX: Only count "Standard" or "Bank Holiday" (Standard) shifts towards the 37.5h cap.
                    // Ignore "Overtime" shifts completely as they are already accounted for.
                    if (shift.shiftType === 'Standard' || shift.shiftType === 'Bank Holiday') {
                        let coreMinutes = shift.totalPaidMinutes || 0;
                        
                        // FIX: Subtract any extra time (Late Finish / Early Start) that was likely claimed as OT/TOIL.
                        // We only want the scheduled shift duration to count towards the 37.5h trigger.
                        if (shift.extraTimeWorkedMinutes) coreMinutes -= shift.extraTimeWorkedMinutes;
                        if (shift.earlyStartMinutes) coreMinutes -= shift.earlyStartMinutes;
                        
                        totalMinutes += Math.max(0, coreMinutes);
                    }
                }
            });

            return totalMinutes;
        }
	

        // --- LOCAL STORAGE DATA HANDLING ---

        function loadInitialData() {
    const storedScale = localStorage.getItem('printScaleFactor');
    if (storedScale) {
        PRINT_SCALE_FACTOR = parseFloat(storedScale);
    } else {
        PRINT_SCALE_FACTOR = isAppleDevice ? APPLE_SCALE : DEFAULT_SCALE;
    }

    const scaleDisplayElement = document.getElementById('current-print-scale');
    if (scaleDisplayElement) {
        scaleDisplayElement.value = (PRINT_SCALE_FACTOR * 100).toFixed(0);
    }
			
            const storedProfile = localStorage.getItem(PROFILE_KEY);
            if (storedProfile) {
                try {
                    const parsedProfile = JSON.parse(storedProfile);
                    userProfile = {
                        name: parsedProfile.name || '',
                        payrollNumber: parsedProfile.payrollNumber || '',
                        userEmail: parsedProfile.userEmail || 'username@email.com',
                        contractedHours: parseFloat(parsedProfile.contractedHours) || 37.5
                    };
                    
                    document.getElementById('userName').value = userProfile.name;
                    document.getElementById('payrollNumber').value = userProfile.payrollNumber;
                    document.getElementById('userEmail').value = userProfile.userEmail;

                    const hours = userProfile.contractedHours;
                    const select = document.getElementById('contractedHoursSelect');
                    const customInput = document.getElementById('customContractedHours');

                    const options = Array.from(select.options).map(opt => opt.value);
                    if (options.includes(String(hours))) {
                        select.value = String(hours);
                        document.getElementById('customHoursInputContainer').classList.add('hidden');
                    } else {
                        select.value = 'custom';
                        customInput.value = hours;
                        document.getElementById('customHoursInputContainer').classList.remove('hidden');
                    }


                } catch (e) {
                    console.error("Error parsing stored profile:", e);
                }
            } else {
                userProfile.userEmail = 'username@email.com';
                document.getElementById('userEmail').value = 'username@email.com';
                document.getElementById('contractedHoursSelect').value = '37.5';
            }
            
            updateProfileDisplay();

            const storedShifts = localStorage.getItem(SHIFTS_KEY);
            if (storedShifts) {
                try {
                    userShifts = JSON.parse(storedShifts);
                } catch (e) {
                    console.error("Error parsing stored shifts:", e);
                    userShifts = {};
                }
            }

            renderCalendar();
        }
        
        function updateProfileDisplay() {
            const inputSection = document.getElementById('profile-input-section');
            const displaySection = document.getElementById('displayed-profile-section');
            
            if (userProfile.name && userProfile.payrollNumber) {
                document.getElementById('display-userName').textContent = userProfile.name;
                document.getElementById('display-payrollNumber').textContent = userProfile.payrollNumber;
                document.getElementById('display-userEmail').textContent = userProfile.userEmail; 
                document.getElementById('display-contractedHours').textContent = `${userProfile.contractedHours} Hours`;
                document.getElementById('device-info').textContent = detectDeviceAndBrowser();
				
                displaySection.classList.remove('hidden');
                inputSection.classList.add('hidden');
            } else {
                inputSection.classList.remove('hidden');
                displaySection.classList.add('hidden');
            }
        }
        
        window.checkCustomContractedHours = function() {
            const select = document.getElementById('contractedHoursSelect');
            const customContainer = document.getElementById('customHoursInputContainer');
            if (select.value === 'custom') {
                customContainer.classList.remove('hidden');
            } else {
                customContainer.classList.add('hidden');
            }
        }

        window.editProfile = function() {
            document.getElementById('userName').value = userProfile.name || '';
            document.getElementById('payrollNumber').value = userProfile.payrollNumber || '';
            document.getElementById('userEmail').value = userProfile.userEmail || 'username@email.com';
            
            const hours = userProfile.contractedHours;
            const select = document.getElementById('contractedHoursSelect');
            const customInput = document.getElementById('customContractedHours');
            const customContainer = document.getElementById('customHoursInputContainer');

            const options = Array.from(select.options).map(opt => opt.value);
            if (options.includes(String(hours))) {
                select.value = String(hours);
                customContainer.classList.add('hidden');
            } else {
                select.value = 'custom';
                customInput.value = hours;
                customContainer.classList.remove('hidden');
            }
            
            document.getElementById('profile-input-section').classList.remove('hidden');
            document.getElementById('displayed-profile-section').classList.add('hidden');
        }

        window.saveProfile = function() {
            const name = document.getElementById('userName').value.trim();
            const payrollNumber = document.getElementById('payrollNumber').value.trim();
            const userEmail = document.getElementById('userEmail').value.trim();
            const hoursSelect = document.getElementById('contractedHoursSelect').value;
            let contractedHours;

            if (hoursSelect === 'custom') {
                const customHoursInput = document.getElementById('customContractedHours').value;
                contractedHours = parseFloat(customHoursInput) || 37.5; 
            } else {
                contractedHours = parseFloat(hoursSelect) || 37.5;
            }
            
            if (!name || !payrollNumber) {
                showMessageBox("Input Required", "Please enter both your Name and Payroll Number before saving.", true);
                return;
            }

            userProfile = {
                name: name,
                payrollNumber: payrollNumber,
                userEmail: userEmail,
                contractedHours: contractedHours
            };

            try {
                localStorage.setItem(PROFILE_KEY, JSON.stringify(userProfile));
                showMessageBox("Success", "Profile details saved successfully.", true);
            } catch (error) {
                showMessageBox("Error", "Could not save profile.", true);
            }
            
            updateProfileDisplay();
        }

        function saveShiftsToLocalStorage() {
            try {
                localStorage.setItem(SHIFTS_KEY, JSON.stringify(userShifts));
            } catch (error) {
                console.error("Error saving shifts:", error);
            }
        }
        
        // --- CALENDAR RENDERING ---

        function renderCalendar() {
            const date = new Date(currentYear, currentMonth, 1);
            const monthYearDisplay = document.getElementById('current-month-year');
            const grid = document.getElementById('calendar-grid');
            const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            monthYearDisplay.textContent = monthName;
            grid.innerHTML = '';
            
            let startDay = date.getDay(); 
            startDay = startDay === 0 ? 6 : startDay - 1;

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            for (let i = 0; i < startDay; i++) {
                grid.innerHTML += '<div class="calendar-day day-disabled"></div>';
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const shift = userShifts[dateStr];
                const className = getShiftClass(shift, new Date(dateStr));
                
                let shiftInfoHtml = '';
                if (shift) {
                    const paidHours = formatHours(shift.totalPaidMinutes);
                    
                    // Check if times are different from standard
                    const isNonStandard = shift.startTime !== '07:20' || shift.finishTime !== '20:30';
                    const titleText = shift.shiftType + (isNonStandard ? ' !' : '');

                    shiftInfoHtml = `
                        <div class="mt-1 text-xs font-bold text-gray-900 leading-tight">${titleText}</div>
                        <div class="text-[11px] font-medium text-gray-600">${shift.startTime}-${shift.finishTime}</div>
                        <div class="text-xs font-bold text-indigo-700">${paidHours} Hrs</div>
                    `;
                }

                grid.innerHTML += `
                    <div class="calendar-day ${className}" data-date="${dateStr}" onclick="showShiftModal('${dateStr}')">
                        <span class="font-bold text-lg">${i}</span>
                        ${shiftInfoHtml}
                    </div>
                `;
            }
            
            document.getElementById('clear-month-text').textContent = monthName + "'s";
        }

        function getShiftClass(shift, date) {
            if (!shift) {
                return 'bg-white';
            }
            const dayOfWeek = date.getDay();
            switch (shift.shiftType) {
                case 'Standard':
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        return 'shift-weekend-default';
                    }
                    const isModified = shift.earlyStartMinutes > 0 || shift.extraTimeWorkedMinutes > 0 || shift.lateStartMinutes > 0 || shift.earlyFinishMinutes > 0;
                    return isModified ? 'shift-standard-modified' : 'shift-standard-default';
                case 'Overtime':
                    return 'shift-overtime-default';
                case 'Bank Holiday':
                    return 'shift-bank-holiday';
                case 'Bank Holiday Overtime':
                    return 'shift-bh-ot-default';
                default:
                    return 'bg-white';
            }
        }
        
        // --- SHIFT MODAL LOGIC (UPDATED WITH LOOK-BACK) ---

        window.showShiftModal = function(dateStr) {
            if (!userProfile.name || !userProfile.payrollNumber) {
                showMessageBox("Input Required", "Please save your Name and Payroll Number in the profile section first.", true);
                return;
            }
            selectedDate = dateStr;
            const date = new Date(dateStr + 'T00:00:00');
            
            // --- 1. DYNAMIC LABEL UPDATE FOR PART TIME STAFF ---
            const contractHrs = parseFloat(userProfile.contractedHours) || 37.5;
            const isPartTime = contractHrs < 37.5;
            const otSpan = document.querySelector('input[value="Overtime"]').nextElementSibling;
            if (otSpan) {
                otSpan.textContent = isPartTime ? "Extra Hours / Overtime (Additional Shifts)" : "Overtime (Non-BH)";
            }
            
            // --- 2. CHECK WEEKLY HOURS (AUTO-DETECT EXTRA HOURS) ---
            const shift = userShifts[dateStr];
            let defaultType = "Standard";
            
            if (!shift && isPartTime) {
                const minutesSoFar = getWeeklyPaidMinutes(dateStr);
                const contractedMinutes = contractHrs * 60;
                
                // If they have already worked their hours, default to Extra Hours
                if (minutesSoFar >= contractedMinutes) {
                    defaultType = "Overtime"; 
                }
            }
            
            document.getElementById('modal-date-display').textContent = `Shift Details for ${date.toDateString()}`;
            
            const form = document.getElementById('shift-form');
            const deleteBtn = document.getElementById('delete-shift-btn');

            if (shift) {
                document.getElementById('startTime').value = shift.startTime;
                document.getElementById('finishTime').value = shift.finishTime;
                document.getElementById('breaksCount').value = shift.breaksCount;
                // Load Notes
                document.getElementById('shiftNotes').value = shift.notes || '';
                document.querySelector(`input[name="shiftType"][value="${shift.shiftType}"]`).checked = true;
                deleteBtn.classList.remove('hidden');
                
                shift.deviation = {
                    earlyStartEnhancement: shift.earlyStartEnhancement,
                    lateFinishEnhancement: shift.lateFinishEnhancement,
                    lateStartAdjustment: shift.lateStartAdjustment,
                    earlyFinishAdjustment: shift.earlyFinishAdjustment
                };
            } else {
                form.reset();
                document.getElementById('startTime').value = '07:20';
                document.getElementById('finishTime').value = '20:30';
                document.getElementById('breaksCount').value = '2';
                // Clear Notes
                document.getElementById('shiftNotes').value = '';
                
                // Apply the auto-detected type
                document.querySelector(`input[name="shiftType"][value="${defaultType}"]`).checked = true;

                if (userShifts[dateStr]) {
                    delete userShifts[dateStr].deviation;
                }
                deleteBtn.classList.add('hidden');
            }
            
            form.onsubmit = handleSaveShift;
            calculateEnhancements(); 
            document.getElementById('shift-modal').classList.remove('hidden');
        }

        window.closeShiftModal = function() {
            document.getElementById('shift-modal').classList.add('hidden');
            selectedDate = null;
        }
        
        window.clearAllShifts = function() {
            const yearMonthPrefix = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const shiftsToKeep = {};
            
            Object.keys(userShifts).forEach(dateStr => {
                if (!dateStr.startsWith(yearMonthPrefix)) {
                    shiftsToKeep[dateStr] = userShifts[dateStr];
                }
            });
            
            if (Object.keys(userShifts).length === Object.keys(shiftsToKeep).length) {
                showMessageBox("No Shifts", "There are no shifts recorded for the current month.", true);
                return;
            }

            if (confirm(`Are you sure you want to delete ALL shifts for the current month?`)) {
                userShifts = shiftsToKeep;
                saveShiftsToLocalStorage();
                showMessageBox("Success", "All shifts for the current month have been deleted.", true);
                renderCalendar();
            }
        }

        // --- PRINT SCALE MANAGEMENT --- 
        window.changePrintScale = function() {
            const scaleInput = document.getElementById('current-print-scale');
            let newScalePercent = parseInt(scaleInput.value, 10);

            if (isNaN(newScalePercent) || newScalePercent < 10 || newScalePercent > 200) {
                alert("Please enter a valid percentage between 10 and 200.");
                scaleInput.value = (PRINT_SCALE_FACTOR * 100).toFixed(0);
                return;
            }
            PRINT_SCALE_FACTOR = newScalePercent / 100;
            localStorage.setItem('printScaleFactor', PRINT_SCALE_FACTOR.toFixed(2));
            alert(`Print scale set to ${newScalePercent}%.`);
        }

        window.resetPrintScale = function() {
            const defaultScale = isAppleDevice ? APPLE_SCALE : DEFAULT_SCALE;
            PRINT_SCALE_FACTOR = defaultScale;
            localStorage.removeItem('printScaleFactor');

            const scaleInput = document.getElementById('current-print-scale');
            scaleInput.value = (defaultScale * 100).toFixed(0);
            alert(`Print scale reset to default.`);
        }
        

        // --- CORE CALCULATIONS (UPDATED WITH WEEKLY STATUS) ---
        
		window.calculateEnhancements = function() {
        if (!selectedDate) return;

        // --- 1. GET SETTINGS & INPUTS ---
        const deviationData = userShifts[selectedDate]?.deviation || {};
        
        // Capture live dropdown values
        const currentEarlyStartVal = document.getElementById('earlyStartEnhancement')?.value;
        const currentLateFinishVal = document.getElementById('lateFinishEnhancement')?.value;
        const currentLateStartVal = document.getElementById('lateStartAdjustment')?.value;
        const currentEarlyFinishVal = document.getElementById('earlyFinishAdjustment')?.value;
        const currentPtOtAction = document.getElementById('partTimeOvertimeAction')?.value;
        const currentFtOtAction = document.getElementById('fullTimeOvertimeAction')?.value;
        const currentExcessAction = document.getElementById('excessHoursAction')?.value;

        // Capture live "Split" input if it exists
        const currentSplitOTInput = document.getElementById('excessSplitOT')?.value;

        const shiftType = document.querySelector('input[name="shiftType"]:checked').value;
        const startTimeStr = document.getElementById('startTime').value;
        const finishTimeStr = document.getElementById('finishTime').value;
        const breaksCount = parseInt(document.getElementById('breaksCount').value, 10);
        
        const contractHrs = parseFloat(userProfile.contractedHours) || 37.5;
        const isPartTime = contractHrs < 37.5;
        const FULL_TIME_MINUTES = 2250; // 37.5 Hours
        
        const otLabel = isPartTime ? 'Record as Extra Hours' : 'Record as Overtime';
        const defaultPositiveDeviation = isPartTime ? 'Overtime' : 'Toil'; 

        if (!startTimeStr || !finishTimeStr) {
            document.getElementById('enhancement-display').innerHTML = '<p class="text-red-600">Please enter valid times.</p>';
            return;
        }

        // --- 2. TIME CALCULATIONS ---
        const startMinutes = timeToMinutes(startTimeStr);
        const finishMinutes = timeToMinutes(finishTimeStr);
        
        const breakSection = document.getElementById('breaks-section');
        if (startMinutes > timeToMinutes('13:00') || finishMinutes < timeToMinutes('18:00')) {
            breakSection.classList.remove('hidden');
        } else {
            breakSection.classList.add('hidden');
            document.getElementById('breaksCount').value = '2'; 
        }
        const totalBreaksMinutes = breaksCount * 20;

        let totalShiftMinutes = finishMinutes > startMinutes ? finishMinutes - startMinutes : (1440 - startMinutes) + finishMinutes;
        const totalPaidMinutes = Math.max(0, totalShiftMinutes - totalBreaksMinutes);

        // --- ENHANCEMENT CALCULATIONS ---
        const enhancements = {
            earlyStartMinutes: Math.max(0, DEFAULT_START_TIME_MINUTES - startMinutes),
            lateStartMinutes: Math.max(0, startMinutes - DEFAULT_START_TIME_MINUTES),
            earlyFinishMinutes: Math.max(0, DEFAULT_END_TIME_MINUTES - finishMinutes),
            extraTimeWorkedMinutes: Math.max(0, finishMinutes - DEFAULT_END_TIME_MINUTES),
            nightDuty: 0,
            weekendEnhancement: 0,
            bankHolidayEnhancement: 0,
            totalPaidMinutes: totalPaidMinutes,
            partTimeExtraMinutes: 0,
            partTimeOvertimeMinutes: 0, // Used for OT portion
            partTimeToilMinutes: 0      // Used for TOIL portion
        };
        
        // Calculate "Core" minutes (Scheduled time only, excluding OT at ends)
        const currentShiftCoreMinutes = Math.max(0, totalPaidMinutes - enhancements.extraTimeWorkedMinutes - enhancements.earlyStartMinutes);

        // WEEKLY CUMULATIVE CALCULATION
        const previousWeeklyMinutes = getWeeklyPaidMinutes(selectedDate);
        const currentTotalWeeklyMinutes = previousWeeklyMinutes + currentShiftCoreMinutes; 
        
        // --- LOGIC: CHECK FOR 37.5h CROSSOVER ---
        let excessMinutes = 0;
        
        if (shiftType === 'Standard' || shiftType === 'Bank Holiday') {
            if (currentTotalWeeklyMinutes > FULL_TIME_MINUTES) {
                const minutesAllowed = Math.max(0, FULL_TIME_MINUTES - previousWeeklyMinutes);
                if (minutesAllowed < currentShiftCoreMinutes) {
                    excessMinutes = currentShiftCoreMinutes - minutesAllowed;
                    
                    // Default allocation (Overtime)
                    enhancements.partTimeOvertimeMinutes = excessMinutes; 
                    enhancements.partTimeExtraMinutes = totalPaidMinutes - excessMinutes;
                }
            } else {
                enhancements.partTimeExtraMinutes = totalPaidMinutes;
            }
        }
        
        // Standard Enhancements
        const date = new Date(selectedDate);
        const dayOfWeek = date.getDay(); 
        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
            const nightStart = 1200; 
            const effectiveNightFinish = Math.min(finishMinutes, DEFAULT_END_TIME_MINUTES);
            if (effectiveNightFinish > nightStart) {
                enhancements.nightDuty = Math.max(0, effectiveNightFinish - Math.max(startMinutes, nightStart));
            }
        }
        if (dayOfWeek === 6 || dayOfWeek === 0) enhancements.weekendEnhancement = totalPaidMinutes;
        if (shiftType === 'Bank Holiday' || shiftType === 'Bank Holiday Overtime') enhancements.bankHolidayEnhancement = totalPaidMinutes;

        // --- 4. DEVIATION & DISPLAY ---
        const deviationSetup = {
            earlyStartEnhancement: currentEarlyStartVal || deviationData.earlyStartEnhancement || defaultPositiveDeviation, 
            lateFinishEnhancement: currentLateFinishVal || deviationData.lateFinishEnhancement || defaultPositiveDeviation,
            lateStartAdjustment: currentLateStartVal || deviationData.lateStartAdjustment || 'Neg Toil',
            earlyFinishAdjustment: currentEarlyFinishVal || deviationData.earlyFinishAdjustment || 'Neg Toil',
            partTimeOvertimeAction: currentPtOtAction || deviationData.partTimeOvertimeAction || 'Overtime',
            fullTimeOvertimeAction: currentFtOtAction || deviationData.fullTimeOvertimeAction || 'Overtime',
            excessHoursAction: currentExcessAction || deviationData.excessHoursAction || 'Overtime',
            // Load saved Split data or initialize
            excessSplitOT: deviationData.excessSplitOT || 0,
        };

        // --- LOGIC: HANDLE MANUAL SPLIT ---
        if (deviationSetup.excessHoursAction === 'Split' && excessMinutes > 0) {
            // 1. Determine the Split Values
            let splitOT = 0;

            if (currentSplitOTInput !== undefined && currentSplitOTInput !== null && currentSplitOTInput !== '') {
                // User is typing/changing input
                splitOT = parseFloat(currentSplitOTInput) * 60; // Convert input hours to minutes
            } else if (deviationData.excessHoursAction === 'Split' && deviationData.excessSplitOT !== undefined) {
                // Load saved data
                splitOT = deviationData.excessSplitOT;
            } else {
                // Default to 50/50 on first load
                splitOT = excessMinutes / 2;
            }
            
            // Safety Clamp
            if (splitOT < 0) splitOT = 0;
            if (splitOT > excessMinutes) splitOT = excessMinutes;

            const splitToil = excessMinutes - splitOT;

            // Update Calculation Objects
            enhancements.partTimeOvertimeMinutes = splitOT;
            enhancements.partTimeToilMinutes = splitToil;
            
            // Save for persistence
            deviationSetup.excessSplitOT = splitOT;
        }

        const displayDiv = document.getElementById('enhancement-display');
        const selectorContainer = document.getElementById('deviation-selectors');
        let html = ``;
        let selectorHtml = `<p class="font-bold text-lg mb-2 text-yellow-800">Time Deviation Management</p>`;
        let hasDeviations = false;

        // Status Bar
        const percent = Math.min(100, (currentTotalWeeklyMinutes / 2250) * 100);
        const isOverContract = currentTotalWeeklyMinutes > 2250;
        const colorClass = isOverContract ? 'text-purple-700 bg-purple-50' : 'text-green-700 bg-green-50';
        
        html += `
            <div class="mb-3 p-2 rounded border ${isOverContract ? 'border-purple-200' : 'border-green-200'} ${colorClass} text-xs">
                <p class="font-bold flex justify-between">
                    <span>Weekly Total (Standard Hrs):</span>
                    <span>${formatHours(currentTotalWeeklyMinutes)} / 37.50 Hrs</span>
                </p>
                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                    <div class="${isOverContract ? 'bg-purple-600' : 'bg-green-600'} h-1.5 rounded-full" style="width: ${percent}%"></div>
                </div>
            </div>
        `;

        html += `<p>Total Paid Time: <span class="font-bold">${formatHours(totalPaidMinutes)} hrs</span></p>`;
        
        if (enhancements.nightDuty > 0) html += `<p>â€¢ Night Duty (20:00-20:30): <strong>${formatHours(enhancements.nightDuty)} hrs</strong></p>`;
        if (enhancements.weekendEnhancement > 0 && (shiftType === 'Standard' || isPartTime)) html += `<p>â€¢ Weekend: <strong>${formatHours(enhancements.weekendEnhancement)} hrs</strong></p>`;
        if (enhancements.bankHolidayEnhancement > 0) html += `<p>â€¢ Bank Holiday: <strong>${formatHours(enhancements.bankHolidayEnhancement)} hrs</strong></p>`;

        // Helper for Selectors
        const makeSelect = (id, label, currentVal, options) => {
            const opts = options.map(o => `<option value="${o.val}" ${currentVal === o.val ? 'selected' : ''}>${o.txt}</option>`).join('');
            return `<div><label class="block text-sm font-medium text-gray-700">${label}</label>
                    <select id="${id}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" onchange="calculateEnhancements()">${opts}</select></div>`;
        };

        // 1. EXCESS HOURS SELECTOR
        if (excessMinutes > 0 && (shiftType === 'Standard' || shiftType === 'Bank Holiday')) {
            hasDeviations = true;
            
            // Text Summary of Split
            let splitText = '';
            if (deviationSetup.excessHoursAction === 'Split') {
                splitText = `<ul class="list-disc list-inside mt-1 text-xs">
                    <li>Pay as Overtime: <strong>${formatHours(enhancements.partTimeOvertimeMinutes)} hrs</strong></li>
                    <li>Accrue as TOIL: <strong>${formatHours(enhancements.partTimeToilMinutes)} hrs</strong></li>
                </ul>`;
            }

            html += `<div class="mt-2 p-2 bg-indigo-100 rounded text-xs border border-indigo-200">
                <p class="font-bold text-indigo-800">Weekly Contract (37.5h) Exceeded</p>
                <p class="mt-1">Excess Hours: <strong>${formatHours(excessMinutes)} hrs</strong></p>
                ${splitText}
             </div>`;

            selectorHtml += makeSelect('excessHoursAction', 
                `<strong>Action for Excess (${formatHours(excessMinutes)} hrs):</strong>`, 
                deviationSetup.excessHoursAction,
                [
                    {val: 'Overtime', txt: '1. Pay as Overtime'}, 
                    {val: 'Toil', txt: '2. Accrue as TOIL'},
                    {val: 'Split', txt: '3. Manual Split (OT & TOIL)'}
                ]
            );

            // RENDER SPLIT INPUTS
            if (deviationSetup.excessHoursAction === 'Split') {
                selectorHtml += `
                   <div class="flex space-x-4 mt-2 ml-1 p-2 bg-yellow-50 border border-yellow-200 rounded">
                       <div class="w-1/2">
                           <label class="block text-xs font-bold text-gray-700 mb-1">Pay as OT (Hrs)</label>
                           <input type="number" id="excessSplitOT" value="${formatHours(enhancements.partTimeOvertimeMinutes)}" step="0.1" 
                               class="w-full text-sm border-gray-300 rounded shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-1"
                               onchange="calculateEnhancements()">
                       </div>
                       <div class="w-1/2">
                           <label class="block text-xs font-bold text-gray-700 mb-1">Accrue TOIL (Hrs)</label>
                           <input type="text" value="${formatHours(enhancements.partTimeToilMinutes)}" disabled
                               class="w-full text-sm border-gray-200 rounded shadow-sm bg-gray-100 text-gray-500 p-1">
                       </div>
                   </div>`;
            }
            
            // Map for Report
            deviationSetup.partTimeOvertimeAction = deviationSetup.excessHoursAction;
        }

        // 2. WHOLE SHIFT OVERTIME
        if (!isPartTime && (shiftType === 'Overtime' || shiftType === 'Bank Holiday Overtime')) {
            hasDeviations = true;
            selectorHtml += makeSelect('fullTimeOvertimeAction', 
                `<strong>Whole Shift Action (${formatHours(totalPaidMinutes)} hrs):</strong>`, 
                deviationSetup.fullTimeOvertimeAction,
                [{val: 'Overtime', txt: '1. Payment (Overtime)'}, {val: 'Toil', txt: '2. TOIL'}]
            );
        }

        // 3. STANDARD DEVIATIONS
        if (shiftType === 'Standard' || shiftType === 'Bank Holiday') {
            if (enhancements.earlyStartMinutes > 0) {
                hasDeviations = true;
                selectorHtml += makeSelect('earlyStartEnhancement', `Early Start (${formatHours(enhancements.earlyStartMinutes)} hrs):`, deviationSetup.earlyStartEnhancement, 
                    [{val: 'Toil', txt: '1. Record as Toil'}, {val: 'Overtime', txt: `2. ${otLabel}`}]);
            }
            if (enhancements.extraTimeWorkedMinutes > 0) {
                hasDeviations = true;
                selectorHtml += makeSelect('lateFinishEnhancement', `Late Finish (${formatHours(enhancements.extraTimeWorkedMinutes)} hrs):`, deviationSetup.lateFinishEnhancement, 
                    [{val: 'Toil', txt: '1. Record as Toil'}, {val: 'Overtime', txt: `2. ${otLabel}`}]);
            }
            if (enhancements.lateStartMinutes > 0) {
                hasDeviations = true;
                selectorHtml += makeSelect('lateStartAdjustment', `Late Start (-${formatHours(enhancements.lateStartMinutes)} hrs):`, deviationSetup.lateStartAdjustment,
                    [{val: 'Neg Toil', txt: '1. Deduct from Toil'}, {val: 'AL', txt: '2. Deduct from Annual Leave'}]);
            }
            if (enhancements.earlyFinishMinutes > 0) {
                hasDeviations = true;
                selectorHtml += makeSelect('earlyFinishAdjustment', `Early Finish (-${formatHours(enhancements.earlyFinishMinutes)} hrs):`, deviationSetup.earlyFinishAdjustment,
                    [{val: 'Neg Toil', txt: '1. Deduct from Toil'}, {val: 'AL', txt: '2. Deduct from Annual Leave'}]);
            }
        }

        selectorContainer.innerHTML = selectorHtml;
        selectorContainer.classList.toggle('hidden', !hasDeviations);

        displayDiv.innerHTML = html;
        document.getElementById('shift-form').dataset.calculated = JSON.stringify({ ...enhancements, ...deviationSetup });
    }

        
        // --- SHIFT DATA HANDLING (LOCAL SAVE/DELETE) ---

        window.handleSaveShift = async function(event) {
            event.preventDefault();

            if (!selectedDate || !userProfile.name) {
                showMessageBox("Error", "Please select a date and save your profile first.", true);
                return;
            }

            const shiftType = document.querySelector('input[name="shiftType"]:checked').value;
            const startTime = document.getElementById('startTime').value;
            const finishTime = document.getElementById('finishTime').value;
            const breaksCount = parseInt(document.getElementById('breaksCount').value, 10);
            
            const calculatedData = JSON.parse(document.getElementById('shift-form').dataset.calculated || '{}');

            const newShift = {
                shiftType,
                startTime,
                finishTime,
                breaksCount,
                notes: document.getElementById('shiftNotes').value, // NEW: Save Notes
                ...calculatedData,
                userName: userProfile.name,
                payrollNumber: userProfile.payrollNumber,
                userEmail: userProfile.userEmail,
                date: selectedDate,
                contractedHours: userProfile.contractedHours
            };

            userShifts[selectedDate] = newShift;
            saveShiftsToLocalStorage();

            showMessageBox("Success", `Shift for ${selectedDate} saved as ${shiftType}.`, true);
            closeShiftModal();
            renderCalendar();
        }


        window.deleteShift = function() {
            if (!selectedDate || !userShifts[selectedDate]) {
                return;
            }

            if (confirm(`Are you sure you want to delete the shift for ${selectedDate}?`)) {
                delete userShifts[selectedDate];
                saveShiftsToLocalStorage();
                showMessageBox("Success", `Shift for ${selectedDate} has been deleted.`, true);
                closeShiftModal();
                renderCalendar();
            }
        }
        
        // --- REPORT GENERATION ---
        
        window.generateReport = function() {
        if (!userProfile.name || !userProfile.payrollNumber) {
            showMessageBox("Error", "Please save your Name and Payroll Number in the profile section first.", true);
            return;
        }
        
        showMessageBox("Generating Report", "Calculating totals for the month. Please wait...", false);

        setTimeout(() => {
            const yearMonthPrefix = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const monthName = new Date(currentYear, currentMonth, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const shiftsInMonth = Object.keys(userShifts)
                .filter(dateStr => dateStr.startsWith(yearMonthPrefix))
                .sort()
                .map(dateStr => userShifts[dateStr]);

            const totals = {
                uhSat: 0, uhSun: 0, uhNight: 0, uhBH: 0,
                extraHoursWorked: 0, 
                otMonFri: 0, otSat: 0, otSun: 0, otBH: 0, 
                totalPaidMinutes: 0, 
                toilAccrued: 0, toilUsed: 0, annualLeaveUsed: 0, 
            };

            const detailedPrintShifts = [];
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const isPartTime = userProfile.contractedHours < 37.5;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const shift = userShifts[dateStr];
                const dateObj = new Date(dateStr);
                const dayNamesArr = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

                const baseShift = {
                    date: dateStr,
                    weekday: dayNamesArr[dateObj.getDay()],
                    dayOfMonth: day,
                    shiftType: shift ? shift.shiftType : 'None',
                    startTime: shift ? shift.startTime : '',
                    finishTime: shift ? shift.finishTime : '',
                    notes: shift ? (shift.notes || '') : '',
                    uhSat: 0, uhSun: 0, uhNight: 0, uhBH: 0,
                    extraHours: 0, extraHoursWorked: 0,
                    otMonFri: 0, otSat: 0, otSun: 0, otBH: 0,
                    toilAccrued: 0, toilUsed: 0, annualLeaveUsed: 0
                };

                if (shift) {
                    const dayOfWeek = dateObj.getDay();
                    const totalPaidMinutes = shift.totalPaidMinutes || 0;
                    totals.totalPaidMinutes += totalPaidMinutes;

                    let nightMins = shift.nightDuty || 0;
                    let satMins = (dayOfWeek === 6) ? totalPaidMinutes : 0;
                    let sunMins = (dayOfWeek === 0) ? totalPaidMinutes : 0;
                    let bhMins  = (shift.shiftType.includes('Bank Holiday')) ? totalPaidMinutes : 0;

                    if (shift.shiftType === 'Standard' || shift.shiftType === 'Bank Holiday') {
                        // 1. BASE HOURS
                        totals.uhNight += nightMins; baseShift.uhNight += nightMins;
                        totals.uhSat += satMins;     baseShift.uhSat += satMins;
                        totals.uhSun += sunMins;     baseShift.uhSun += sunMins;
                        if (shift.shiftType === 'Bank Holiday') { totals.uhBH += bhMins; baseShift.uhBH += bhMins; }

                        // 2. STANDARD DEVIATIONS (Late Finish / Early Start)
                        if (shift.extraTimeWorkedMinutes > 0) {
                            if (isPartTime && shift.lateFinishEnhancement === 'Overtime') {
                                baseShift.extraHoursWorked += shift.extraTimeWorkedMinutes;
                                totals.extraHoursWorked += shift.extraTimeWorkedMinutes;
                                baseShift.extraHours = baseShift.extraHoursWorked;
                            } else if (shift.lateFinishEnhancement === 'Overtime') {
                                // Full Time OT
                                if (dayOfWeek >= 1 && dayOfWeek <= 5) { baseShift.otMonFri += shift.extraTimeWorkedMinutes; totals.otMonFri += shift.extraTimeWorkedMinutes; }
                                else if (dayOfWeek === 6) { baseShift.otSat += shift.extraTimeWorkedMinutes; totals.otSat += shift.extraTimeWorkedMinutes; }
                                else if (dayOfWeek === 0) { baseShift.otSun += shift.extraTimeWorkedMinutes; totals.otSun += shift.extraTimeWorkedMinutes; }
                            } else if (shift.lateFinishEnhancement === 'Toil') {
                                baseShift.toilAccrued += shift.extraTimeWorkedMinutes;
                                totals.toilAccrued += shift.extraTimeWorkedMinutes;
                            }
                        }
                        
                        if (shift.earlyStartMinutes > 0) {
                            if (shift.earlyStartEnhancement === 'Overtime' && !isPartTime) {
                                if (dayOfWeek >= 1 && dayOfWeek <= 5) { baseShift.otMonFri += shift.earlyStartMinutes; totals.otMonFri += shift.earlyStartMinutes; }
                                // (Simplification for weekend early starts - usually negligible or OT)
                            } else if (shift.earlyStartEnhancement === 'Toil') {
                                baseShift.toilAccrued += shift.earlyStartMinutes;
                                totals.toilAccrued += shift.earlyStartMinutes;
                            }
                        }

                        // 3. WEEKLY EXCESS HOURS (SPLIT HANDLING)
                        // If we have excess minutes and the action is Split or Overtime
                        if (shift.partTimeOvertimeMinutes > 0) {
                             const ptOt = shift.partTimeOvertimeMinutes;
                             const ptAction = shift.excessHoursAction || 'Overtime';

                             if (isPartTime) {
                                 // Add to Extra Hours Worked
                                 baseShift.extraHoursWorked += ptOt;
                                 totals.extraHoursWorked += ptOt;
                                 baseShift.extraHours = baseShift.extraHoursWorked;
                             } else {
                                 // Full Time Excess Paid as OT
                                 if (shift.shiftType === 'Bank Holiday') { baseShift.otBH += ptOt; totals.otBH += ptOt; }
                                 else if (dayOfWeek >= 1 && dayOfWeek <= 5) { baseShift.otMonFri += ptOt; totals.otMonFri += ptOt; }
                                 else if (dayOfWeek === 6) { baseShift.otSat += ptOt; totals.otSat += ptOt; }
                                 else if (dayOfWeek === 0) { baseShift.otSun += ptOt; totals.otSun += ptOt; }
                             }
                        }
                        
                        // NEW: HANDLE TOIL PORTION OF SPLIT
                        if (shift.excessHoursAction === 'Split' && shift.partTimeToilMinutes > 0) {
                            baseShift.toilAccrued += shift.partTimeToilMinutes;
                            totals.toilAccrued += shift.partTimeToilMinutes;
                        }
                        if (shift.excessHoursAction === 'Toil' && shift.partTimeOvertimeMinutes > 0) {
                            // If they selected full "Toil" for excess
                            baseShift.toilAccrued += shift.partTimeOvertimeMinutes;
                            totals.toilAccrued += shift.partTimeOvertimeMinutes;
                        }

                    } 
                    else if (shift.shiftType === 'Overtime' || shift.shiftType === 'Bank Holiday Overtime') {
                        // WHOLE SHIFT OVERTIME LOGIC
                        if (isPartTime) {
                            // Part Time Logic
                            const ptExtra = shift.partTimeExtraMinutes || totalPaidMinutes; 
                            const ptOt    = shift.partTimeOvertimeMinutes || 0;
                            
                            baseShift.extraHoursWorked += ptExtra;
                            totals.extraHoursWorked += ptExtra;
                            baseShift.extraHours = baseShift.extraHoursWorked;

                            if (ptOt > 0) {
                                if (shift.partTimeOvertimeAction === 'Toil') {
                                    baseShift.toilAccrued += ptOt;
                                    totals.toilAccrued += ptOt;
                                } else {
                                    if (shift.shiftType.includes('Bank Holiday')) { baseShift.otBH += ptOt; totals.otBH += ptOt; }
                                    else if (dayOfWeek >= 1 && dayOfWeek <= 5) { baseShift.otMonFri += ptOt; totals.otMonFri += ptOt; }
                                    else if (dayOfWeek === 6) { baseShift.otSat += ptOt; totals.otSat += ptOt; }
                                    else if (dayOfWeek === 0) { baseShift.otSun += ptOt; totals.otSun += ptOt; }
                                }
                            }
                        } else {
                            // Full Time Logic
                            const ftAction = shift.fullTimeOvertimeAction || 'Overtime';
                            
                            if (ftAction === 'Toil') {
                                baseShift.toilAccrued += totalPaidMinutes;
                                totals.toilAccrued += totalPaidMinutes;
                            } else {
                                if (shift.shiftType === 'Bank Holiday Overtime') { baseShift.otBH += totalPaidMinutes; totals.otBH += totalPaidMinutes; }
                                else if (dayOfWeek >= 1 && dayOfWeek <= 5) { baseShift.otMonFri += totalPaidMinutes; totals.otMonFri += totalPaidMinutes; }
                                else if (dayOfWeek === 6) { baseShift.otSat += totalPaidMinutes; totals.otSat += totalPaidMinutes; }
                                else if (dayOfWeek === 0) { baseShift.otSun += totalPaidMinutes; totals.otSun += totalPaidMinutes; }
                            }
                        }

                        totals.uhNight += nightMins; baseShift.uhNight += nightMins;
                        totals.uhSat += satMins;     baseShift.uhSat += satMins;
                        totals.uhSun += sunMins;     baseShift.uhSun += sunMins;
                        if (shift.shiftType.includes('Bank Holiday')) { totals.uhBH += bhMins; baseShift.uhBH += bhMins; }
                    }
                    
                    if (shift.lateStartAdjustment === 'Neg Toil') { baseShift.toilUsed += shift.lateStartMinutes || 0; totals.toilUsed += shift.lateStartMinutes || 0; }
                    if (shift.earlyFinishAdjustment === 'Neg Toil') { baseShift.toilUsed += shift.earlyFinishMinutes || 0; totals.toilUsed += shift.earlyFinishMinutes || 0; }
                    if (shift.lateStartAdjustment === 'AL') { baseShift.annualLeaveUsed += shift.lateStartMinutes || 0; totals.annualLeaveUsed += shift.lateStartMinutes || 0; }
                    if (shift.earlyFinishAdjustment === 'AL') { baseShift.annualLeaveUsed += shift.earlyFinishMinutes || 0; totals.annualLeaveUsed += shift.earlyFinishMinutes || 0; }
                }
                detailedPrintShifts.push(baseShift);
            }

            // RENDER TABLE
            const reportBody = document.getElementById('report-table-body');
            reportBody.innerHTML = '';
            
            const reportData = [
                { label: 'Unsocial Hrs (Sat)', value: totals.uhSat, color: 'text-orange-700', description: 'Total paid hours on Saturday.' },
                { label: 'Unsocial Hrs (Sun)', value: totals.uhSun, color: 'text-orange-700', description: 'Total paid hours on Sunday.' },
                { label: 'Unsocial Hrs (Night)', value: totals.uhNight, color: 'text-orange-700', description: 'Total night duty minutes (Mon-Fri 20:00+).' },
                { label: 'Unsocial Hrs (Bank Hol)', value: totals.uhBH, color: 'text-orange-700', description: 'Total paid hours on Bank Holiday.' },
                { label: '---', value: 0, isDivider: true },
                { label: 'Overtime (Mon-Fri)', value: totals.otMonFri, color: 'text-red-700', description: 'Total Mon-Fri hours recorded as Overtime.' },
                { label: 'Overtime (Sat)', value: totals.otSat, color: 'text-red-700', description: 'Total Saturday hours recorded as Overtime.' },
                { label: 'Overtime (Sun)', value: totals.otSun, color: 'text-red-700', description: 'Total Sunday hours recorded as Overtime.' },
                { label: 'Overtime (BH)', value: totals.otBH, color: 'text-red-700', description: 'Total Bank Holiday hours recorded as Overtime.' },
                { label: 'Extra Time Worked (Part Time)', value: totals.extraHoursWorked, color: 'text-blue-700', description: 'Additional hours worked by Part Time staff.' },
                { label: '---', value: 0, isDivider: true },
                { label: 'TOIL Accrued (+ Hours)', value: totals.toilAccrued, color: 'text-green-700', description: 'Hours assigned to TOIL.' },
                { label: 'TOIL Used (- Hours)', value: totals.toilUsed, color: 'text-red-600', description: 'Hours deducted from TOIL.' },
                { label: 'Annual Leave Used (- Hours)', value: totals.annualLeaveUsed, color: 'text-red-600', description: 'Hours deducted from AL.' },
                { label: '---', value: 0, isDivider: true },
                { label: 'GRAND TOTAL Paid Hours', value: totals.totalPaidMinutes, color: 'text-gray-900', description: 'Total paid hours for the month.', isTotal: true },
            ];

            reportData.forEach(item => {
                if (item.isDivider) {
                    reportBody.innerHTML += `<tr><td colspan="3" class="h-4 border-b-2 border-gray-300"></td></tr>`;
                    return;
                }
                reportBody.innerHTML += `
                    <tr class="${item.isTotal ? 'bg-indigo-100 font-bold' : ''}">
                        <td class="py-2 px-2 text-sm font-medium ${item.color}">${item.label}</td>
                        <td class="py-2 px-2 text-sm font-bold text-right ${item.color}">${formatHours(item.value)}</td>
                        <td class="py-2 px-2 text-xs text-gray-500 hidden md:table-cell">${item.description}</td>
                    </tr>
                `;
            });

            // Detailed List Logic
            const detailedList = document.getElementById('detailed-shift-list');
            detailedList.innerHTML = '';
            
            if (shiftsInMonth.length === 0) {
                detailedList.innerHTML = '<p class="text-center text-gray-500 p-4">No shifts recorded for this month.</p>';
            } else {
                shiftsInMonth.forEach(shift => {
                    const dateObj = new Date(shift.date + 'T00:00:00');
                    const dayOfWeek = dayNamesArr[dateObj.getDay()];
                    const paidHoursText = `<span class="text-indigo-600 font-semibold">${formatHours(shift.totalPaidMinutes)} Paid Hrs</span>`;
                    
                    let toilText = [];
                    if (shift.earlyStartMinutes > 0 && shift.earlyStartEnhancement === 'Toil') toilText.push(`+${formatHours(shift.earlyStartMinutes)} TOIL`);
                    if (shift.extraTimeWorkedMinutes > 0 && shift.lateFinishEnhancement === 'Toil') toilText.push(`+${formatHours(shift.extraTimeWorkedMinutes)} TOIL`);
                    // NEW: Split TOIL display
                    if (shift.excessHoursAction === 'Split' && shift.partTimeToilMinutes > 0) toilText.push(`+${formatHours(shift.partTimeToilMinutes)} TOIL (Excess Split)`);
                    
                    let otText = [];
                    const otLabel = isPartTime ? 'Extra Hrs' : 'OT';
                    
                    if (shift.shiftType.includes('Overtime')) otText.push(`${formatHours(shift.totalPaidMinutes)} ${otLabel}`);
                    if (shift.earlyStartEnhancement === 'Overtime') otText.push(`+${formatHours(shift.earlyStartMinutes)} ${otLabel}`);
                    if (shift.lateFinishEnhancement === 'Overtime') otText.push(`+${formatHours(shift.extraTimeWorkedMinutes)} ${otLabel}`);
                    // NEW: Split OT display
                    if (shift.partTimeOvertimeMinutes > 0 && (shift.excessHoursAction === 'Split' || shift.excessHoursAction === 'Overtime')) {
                        otText.push(`+${formatHours(shift.partTimeOvertimeMinutes)} ${otLabel} (Excess)`);
                    }

                    detailedList.innerHTML += `
                        <div class="p-3 rounded-xl border border-gray-300 bg-white shadow-sm">
                            <p class="font-bold text-base text-gray-800">${dateObj.toDateString()} (${dayOfWeek})</p>
                            <p class="text-xs text-gray-600"><strong>${shift.shiftType}</strong>: ${shift.startTime} - ${shift.finishTime}</p>
                            <div class="mt-1 text-xs space-x-3">${paidHoursText} ${toilText.length?`<span class="text-green-700">${toilText.join(' / ')}</span>`:''} ${otText.length?`<span class="text-blue-600">${otText.join(' / ')}</span>`:''}
                            </div>
                        </div>
                    `;
                });
            }

            currentReportData = { totals, shiftsInMonth: detailedPrintShifts, monthName };
            
            document.getElementById('report-title').textContent = `Monthly Shift Report for ${monthName}`;
            document.getElementById('report-period').textContent = `Generated on ${new Date().toLocaleDateString('en-US', { dateStyle: 'medium' })}`;
            
            hideMessageBox();
            document.getElementById('report-modal').classList.remove('hidden');

        }, 50);
    }

window.executePrintReport = function() {
    const { shiftsInMonth, monthName } = currentReportData;
    const profile = userProfile;
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    if (!monthName) {
        alert("Please generate the report first before attempting to print.");
        return;
    }

    const printScaleStyle = `
        @page { 
            size: A4 portrait;
            margin: 10mm;
        }
        body { 
            transform: scale(${PRINT_SCALE_FACTOR}); 
            transform-origin: top left; 
            -webkit-print-color-adjust: exact; 
            color-adjust: exact;
            margin: 0;
            padding: 0;
        }
        * { box-sizing: border-box; }
        .print-page {
            max-width: 780px; 
            margin: 0 auto;
            padding: 5px;
            font-family: 'Inter', sans-serif;
            font-size: 9pt;
            color: #333;
        } 
        th, td { -webkit-print-color-adjust: exact; color-adjust: exact; }
        .header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; } 
        h1 { font-size: 1.2em; font-weight: bold; text-align: center; margin-bottom: 10px; }
        .details { margin-bottom: 10px; line-height: 1.4; } 
        .sub-heading { font-weight: bold; margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid #ccc; padding-bottom: 2px; }
        .instructions { margin-left: 10px; margin-bottom: 15px; font-size: 0.9em; } 
        .instructions li { margin-bottom: 5px; } 
        table { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 0.8em; } 
        th { background-color: #ddd; font-weight: bold; padding: 4px 2px; border: 1px solid #000; text-align: center; vertical-align: middle; line-height: 1.1; } 
        td { border-right: 1px solid #000; border-bottom: 1px dashed #ccc; padding: 2px; text-align: center; vertical-align: top; }
        td:first-child { border-left: 1px solid #000; } 
        tr:last-child td { border-bottom: 1px solid #000; }
        .fill-line { display: inline-block; border-bottom: 1px solid #000; width: 250px; text-align: left; padding: 0 5px; }
        .blank-signature-line { display: inline-block; border-bottom: 1px solid #000; text-align: left; padding: 0 5px; }
    `;

    const tableRows = shiftsInMonth.map(shift => {
        const day = shift.dayOfMonth;
        const topBorderStyle = day === 1 ? 'border-top: 1px solid #000;' : '';

        return `
            <tr>
                <td style="width: 5%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${day}</td>
                <td style="width: 5%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${shift.weekday}</td>
                <td style="width: 8%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${shift.startTime}</td>
                <td style="width: 8%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${shift.finishTime}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.uhSat)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.uhSun)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.uhNight)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.uhBH)}</td>
                <td style="width: 8%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.extraHours)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.otMonFri)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.otSat)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.otSun)}</td>
                <td style="width: 6%; padding: 2px; text-align: center; border-right: 1px solid #000; border-bottom: 1px dashed #ccc; ${topBorderStyle}">${formatHoursForPrint(shift.otBH)}</td>
            </tr>
        `;
    }).join('');

    const totalRow = `
        <tr style="font-weight: bold; background-color: #ddd;">
            <td colspan="4" style="text-align: right; border: 1px solid #000; padding: 4px 2px;">TOTALS:</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.uhSat)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.uhSun)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.uhNight)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.uhBH)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.extraHoursWorked)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.otMonFri)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.otSat)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.otSun)}</td>
            <td style="border: 1px solid #000; padding: 4px 2px;">${formatHoursForPrint(currentReportData.totals.otBH)}</td>
        </tr>
    `;

    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Shift Report - ${monthName}</title>
            <style>${printScaleStyle}</style>
        </head>
        <body>
            <div class="print-page">
			<div class="header-row" style="display: flex; justify-content: space-between; align-items: center;">
				<div style="width: auto; flex-grow: 1; text-align: left;">
					<h1 style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1.1em; margin: 0;">UNSOCIAL HOURS & OVERTIME CLAIM FORM - MONTHLY PAID STAFF (non-medical)</h1>
				</div>
				<div style="width: 160px; flex-shrink: 0; text-align: right; margin-left: 10px;">
					<img src="https://raw.githubusercontent.com/novacustard-sthmri/timesheet/main/STH_logo.png" alt="STH Logo" style="max-width: 150px; height: auto;">
					<p style="font-size: 8px; margin-top: 2px; color: #555;">STH NHS Foundation Trust Logo</p>
				</div>
			</div>
                <div class="details" style="font-size: 0.9em;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="display: inline-block; white-space: nowrap;">
                            <span style="font-weight: bold; padding-right: 5px;">Name:</span>
                            <span class="fill-line">${profile.name}</span>
                        </span>
                        <span style="display: inline-block; white-space: nowrap;">
                            <span style="font-weight: bold; padding-right: 5px;">Dept:</span>
                            <span class="fill-line"> MIMP </span>
                        </span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="display: inline-block; white-space: nowrap;">
                            <span style="font-weight: bold; padding-right: 5px;">Assignment No:</span>
                            <span class="fill-line">${profile.payrollNumber}</span>
                        </span>
                        <span style="display: inline-block; white-space: nowrap;">
                            <span style="display: inline-block; text-align: right; font-weight: bold;">Claim for the month of:</span>
                            <span class="fill-line">${monthName}</span>
                        </span>
                    </div>
                </div>
                <ul class="instructions">
                    <li>ONLY hours attracting payments over and above basic hours need recording on this claim form.</li>
                    <li>All hours claimed must be exclusive of meal breaks and time off in lieu (TOIL).</li>
                    <li>Claims must be received by Payroll Services by the 4th of the following month.</li>
                </ul>
                <table>
                    <thead>
                        <tr style="background-color: #ddd;">
                            <th rowspan="2" style="width: 5%;">Day</th>
                            <th rowspan="2" style="width: 5%;">D/W</th>
                            <th rowspan="2" style="width: 8%;">Shift Start (time)</th>
                            <th rowspan="2" style="width: 8%;">Shift End (time)</th>
                            <th colspan="4">Unsocial Hours Enhancements</th>
                            <th rowspan="2" style="width: 8%;">Extra Hours (20:30>)</th>
                            <th colspan="4">Overtime</th>
                        </tr>
                        <tr style="background-color: #ddd;">
                            <th style="width: 6%;">Sat</th>
                            <th style="width: 6%;">Sun</th>
                            <th style="width: 6%;">Night</th>
                            <th style="width: 6%;">Bank Hol</th>
                            <th style="width: 6%;">Mon-Fri</th>
                            <th style="width: 6%;">Sat</th>
                            <th style="width: 6%;">Sun</th>
                            <th style="width: 6%;">Bank Hol</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}${totalRow}</tbody>
                </table>
                <h2 class="sub-heading">Declaration</h2>
                <div class="details" style="font-size: 0.9em;">
                    <p style="margin-bottom: 15px;">I certify that the above claim is correct and in accordance with my attendance record.</p>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
                        <div style="width: 65%; text-align: left;">
                            <span style="font-weight: bold; padding-right: 5px;">Employee Signature:</span>
                            <span class="blank-signature-line" style="width: 230px;"></span>
                        </div>
                        <div style="width: 35%; text-align: center;">
                            <span style="font-weight: bold; padding-right: 5px;">Date:</span>
                            <span class="blank-signature-line" style="width: 120px;"></span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
                        <div style="width: 65%; text-align: left;">
                            <span style="font-weight: bold; padding-right: 5px;">Authorising Signature (manager):</span>
                            <span class="blank-signature-line" style="width: 210px;"></span>
                        </div>
                        <div style="width: 35%; text-align: center;">
                            <span style="font-weight: bold; padding-right: 5px;">Date:</span>
                            <span class="blank-signature-line" style="width: 120px;"></span>
                        </div>
                    </div>
                </div>
            </div>
        </body>
        </html>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

window.showPrintInstructions = function() {
    if (!currentReportData.monthName) {
        alert("Please generate the report first before attempting to print.");
        return;
    }
    
    const deviceType = classifyDeviceForInstructions();
    const modalTitle = document.getElementById('instruction-modal-title');
    const contentDiv = document.getElementById('instruction-content');
    let titleText = "Print Instructions";
    let instructionsHtml = '';

    const commonSteps = `
        <p class="text-sm font-semibold mt-4 text-gray-800">Common Steps for Android/Apple/Windows devices:</p>
        <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
            <li><strong>Layout/Orientation:</strong> Ensure 'Portrait' is selected</li>
			<li><strong>Page Size:</strong> Select A4 or ISO A4</li>
            <li><strong>Print Preview Check:</strong> Check the timesheet fits on one page - adjust print scale if necessary</li>
        </ul>
    `;
    
    const appleInstruction = `
        <h4 class="font-bold text-lg text-indigo-700">Apple Devices (Mac/iPhone/iPad)</h4>
        <p class="text-sm">Apple devices sometimes apply an incorrect default scale.</p>
        <ul class="list-disc list-inside space-y-1 ml-4 text-sm font-medium">
            <li><strong>Scale:</strong> Adjust 'Scale' until the print preview shows a single page (73%)</li>
			<li><strong>Select Destination:</strong> Choose Share to send via email or save to a folder</li>
        </ul>
    `;

    const windowsInstruction = `
        <h4 class="font-bold text-lg text-indigo-700">Windows PC</h4>
        <p class="text-sm">The report is optimized for a full-page width in Portrait mode.</p>
        <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
            <li><strong>Scale:</strong> Ensure 'Default', '100%', or 'Fit to page' is selected.</li>
        </ul>
    `;

    const androidInstruction = `
        <h4 class="font-bold text-lg text-indigo-700">Android Mobile/Tablet</h4>
        <p class="text-sm">Mobile printing can vary by device.</p>
        <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
            <li><strong>Scale:</strong> Use 'Fit to Page' or check the scale is close to 100%.</li>
        </ul>
    `;

    if (deviceType === 'Apple') {
        titleText = "Apple Print Instructions";
        instructionsHtml = appleInstruction + commonSteps;
    } else if (deviceType === 'Android') {
        titleText = "Android Print Instructions";
        instructionsHtml = androidInstruction + commonSteps;
    } else { 
        titleText = "PC Print Instructions";
        instructionsHtml = windowsInstruction + commonSteps;
    }

    modalTitle.textContent = titleText;
    contentDiv.innerHTML = instructionsHtml;
    document.getElementById('instruction-modal').classList.remove('hidden');
}

window.handlePrintButtonClick = function() {
    executePrintReport(); 
    document.getElementById('instruction-modal').classList.add('hidden');
    closeReportModal();
}

window.closeReportModal = function() {
    document.getElementById('report-modal').classList.add('hidden');
}


// --- NEW: SEND TO GOOGLE LOGIC ---

function prepareAndShowSendDialog() {
    const { shiftsInMonth } = currentReportData;
    const tableBody = document.getElementById('send-data-preview-body');
    tableBody.innerHTML = '';

    // Removed localStorage call for URL

    const activeShifts = shiftsInMonth.filter(s => s.shiftType !== 'None');

    if (activeShifts.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center">No data to send for this month.</td></tr>';
    } else {
        activeShifts.forEach(s => {
            tableBody.innerHTML += `
                <tr class="hover:bg-gray-100">
                    <td class="p-2 whitespace-nowrap">${s.date} (${s.weekday})</td>
                    <td class="p-2 text-xs truncate max-w-[100px]">${s.shiftType}</td>
                    <td class="p-2">${s.startTime}-${s.finishTime}</td>
                    <td class="p-2">${formatHoursForPrint(s.uhSat)}${formatHoursForPrint(s.uhSun)}${formatHoursForPrint(s.uhNight)}${formatHoursForPrint(s.uhBH)}</td>
                    <td class="p-2">${formatHoursForPrint(s.extraHoursWorked)}</td>
                    <td class="p-2">${formatHoursForPrint(s.otMonFri)}${formatHoursForPrint(s.otSat)}${formatHoursForPrint(s.otSun)}${formatHoursForPrint(s.otBH)}</td>
                    <td class="p-2">${formatHoursForPrint(s.toilAccrued)} ${formatHoursForPrint(s.toilUsed)}</td>
                    <td class="p-2">${formatHoursForPrint(s.annualLeaveUsed)}</td>
                    <td class="p-2 italic text-xs text-gray-500 truncate max-w-[150px]">${s.notes}</td>
                </tr>
            `;
        });
    }

    document.getElementById('send-data-modal').classList.remove('hidden');
}

function getPayloadData() {
    const shiftsToSend = currentReportData.shiftsInMonth.filter(s => s.shiftType !== 'None');
    
    return {
        user: {
            name: userProfile.name,
            assignmentNumber: userProfile.payrollNumber,
            email: userProfile.userEmail
        },
        period: currentReportData.monthName,
        generatedAt: new Date().toISOString(),
        shifts: shiftsToSend.map(s => ({
            date: s.date,
            weekday: s.weekday,
            shiftType: s.shiftType,
            startTime: s.startTime,
            finishTime: s.finishTime,
            uhSat: minutesToDecimalHours(s.uhSat),
            uhSun: minutesToDecimalHours(s.uhSun),
            uhNight: minutesToDecimalHours(s.uhNight),
            uhBH: minutesToDecimalHours(s.uhBH),
            extraHoursWorked: minutesToDecimalHours(s.extraHoursWorked),
            otMonFri: minutesToDecimalHours(s.otMonFri),
            otSat: minutesToDecimalHours(s.otSat),
            otSun: minutesToDecimalHours(s.otSun),
            otBH: minutesToDecimalHours(s.otBH),
            toilAccrued: minutesToDecimalHours(s.toilAccrued),
            toilUsed: minutesToDecimalHours(s.toilUsed),
            annualLeaveUsed: minutesToDecimalHours(s.annualLeaveUsed),
            notes: s.notes
        }))
    };
}

function copyJSONToClipboard() {
    const data = getPayloadData();
    navigator.clipboard.writeText(JSON.stringify(data, null, 2)).then(() => {
        alert("JSON data copied to clipboard!");
    });
}

function sendDataToGoogle() {
    // This grabs the text inside the element with id="xyz"
    const url = document.getElementById('xyz').innerText.trim();
    
    if (!url) {
        alert("Error: Webhook URL not found in HTML (id='xyz').");
        return;
    }
    
    localStorage.setItem('gasWebhookUrl', url);
    
    const btn = document.getElementById('btn-send-gas');
    const originalText = btn.innerText;
    btn.innerText = "Sending...";
    btn.disabled = true;
    btn.classList.add('opacity-50');

    const payload = getPayloadData();

    fetch(url, {
        method: 'POST',
        mode: 'no-cors', 
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(() => {
        alert("Data sent!");
        document.getElementById('send-data-modal').classList.add('hidden');
    })
    .catch(error => {
        console.error('Error:', error);
        alert("Error sending data. Please try again later or contact the mri supers.");
    })
    .finally(() => {
        btn.innerText = originalText;
        btn.disabled = false;
        btn.classList.remove('opacity-50');
    });
}

        // ------------------------------------

        window.changeMonth = function(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();

            loadInitialData();
        };

        // Expose functions globally for HTML
        window.saveProfile = saveProfile;
        window.showShiftModal = showShiftModal;
        window.closeShiftModal = closeShiftModal;
        window.calculateEnhancements = calculateEnhancements;
        window.deleteShift = deleteShift;
        window.generateReport = generateReport;
        window.closeReportModal = closeReportModal;
        window.editProfile = editProfile; 
        window.clearAllShifts = clearAllShifts; 
        window.showPrintInstructions = showPrintInstructions; 
        window.handlePrintButtonClick = handlePrintButtonClick; 
        window.executePrintReport = executePrintReport; 
        window.checkCustomContractedHours = checkCustomContractedHours;
        window.prepareAndShowSendDialog = prepareAndShowSendDialog;
        window.sendDataToGoogle = sendDataToGoogle;
        window.copyJSONToClipboard = copyJSONToClipboard;
    </script>
</body>
</html>
